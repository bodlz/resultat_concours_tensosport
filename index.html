<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>R√©sultat ‚Äî Concours Tensosport üèÄ </title>
  <style>
    :root{ --bg:#0e1325; --card:#151b34; --txt:#eaf0ff; --mut:#a8b3d1; --accent:#ff6b6b; --accent2:#5b5bff; }
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial;background:radial-gradient(1200px 700px at 20% -10%, #1b2550 0,transparent 60%),linear-gradient(180deg,#0c1122,#0e1325);color:var(--txt);display:flex;align-items:center;justify-content:center;padding:24px}
    .wrap{max-width:860px;width:100%}
    header{text-align:center;margin-bottom:18px}
    h1{margin:0 0 6px;font-size:clamp(22px,4.5vw,36px)}
    p{margin:0;color:var(--mut)}
    .card{background:linear-gradient(180deg,#ffffff14,#00000014);border:1px solid #ffffff20;border-radius:18px;padding:22px;box-shadow:0 18px 60px #0007}
    .center{display:flex;justify-content:center;align-items:center;gap:18px;flex-wrap:wrap}
    .roulette{
      width:160px;height:160px;border-radius:50%;display:grid;place-items:center;font-weight:800;letter-spacing:.3px;
      background:
        conic-gradient(from 0deg, var(--accent), var(--accent2), var(--accent)),
        radial-gradient(circle at 50% 50%, #ffffff10 0 60%, transparent 61%);
      color:white;border:6px solid #ffffff20;box-shadow:0 16px 40px #0008, inset 0 0 0 1px #ffffff35;
      cursor:pointer;user-select:none; transition:.2s;
    }
    .roulette:hover{transform:translateY(-2px)}
    .spin{animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    .winners{margin-top:16px;display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:12px}
    .win{background:#0f1733;border:1px solid #ffffff26;border-radius:14px;padding:12px;display:flex;align-items:center;gap:10px}
    .badge{width:36px;height:36px;border-radius:50%;display:grid;place-items:center;font-weight:900;
      background:linear-gradient(135deg,#22c55e,#10b981);color:white;box-shadow:0 6px 16px #0008}
    .u{font-weight:700}.c{color:var(--mut);font-size:12px}
    .small{font-size:12px;color:var(--mut);text-align:center;margin-top:10px}
    #confetti{position:fixed;inset:0;pointer-events:none}
  </style>
</head>
<body>
  <canvas id="confetti"></canvas>
  <div class="wrap">
    <header>
      <h1>R√©sultats ‚Äî Concours de ldlz la plus belle <span style="color:var(--accent2)">Tensosport üèÄ </span></h1>
      <p>Appuie sur la <b>roulette</b> galinette et <b>5 gagnants</b> vont appara√Ætre.</p>
    </header>

    <div class="card">
      <div class="center" style="margin-bottom:10px">
        <div id="roulette" class="roulette" title="Lancer le tirage">Fais moi tourner </div>
        <div>
          <div id="status" class="small">Chargement des participants‚Ä¶</div>
          <div class="small">R√®gle : Plus tu commentes, plus tu as de chances, alors la prochaine fois, n'h√©sites pas !!!</div>
        </div>
      </div>
      <div id="winners" class="winners" aria-live="polite" aria-atomic="true"></div>
    </div>
  </div>

  <script>
    // ---- config ----
    const participantsUrl = "https://raw.githubusercontent.com/bodlz/resultat_concours_tensosport/refs/heads/main/participants_counts.csv";
    const N_WINNERS = 5; // nombre de gagnants

    const $ = s => document.querySelector(s);
    const status = (t, ok=false)=>{ const el=$('#status'); el.textContent=t; el.style.color = ok ? '#22c55e' : 'var(--mut)'; };

    // Parse CSV "username,count"
    function parseCSV(text){
      const lines = text.trim().split(/\r?\n/);
      const out = [];
      let start = 0;
      if(/username/i.test(lines[0]) && /count/i.test(lines[0])) start = 1;
      for(let i=start;i<lines.length;i++){
        const [u,c] = lines[i].split(',');
        const username = (u||'').replace(/^"+|"+$/g,'').trim();
        const count = parseInt((c||'1').replace(/[^0-9]/g,'')) || 1;
        if(username) out.push({username, count});
      }
      return out;
    }

    // Weighted unique draw
    function drawWeightedUnique(participants, k){
      // pool with repetitions
      let pool = [];
      participants.forEach(p => { for(let i=0;i<p.count;i++) pool.push(p.username); });
      const winners = [];
      const seen = new Set();
      while(winners.length < Math.min(k, participants.length) && pool.length){
        const idx = Math.floor(Math.random()*pool.length);
        const pick = pool[idx];
        if(!seen.has(pick)){
          seen.add(pick);
          winners.push(pick);
          pool = pool.filter(x => x !== pick); // remove winner's tickets
        }
      }
      return winners.map(u => {
        const f = participants.find(p => p.username === u);
        return { username: u, count: f ? f.count : 1 };
      });
    }

    function renderWinners(list){
      const box = $('#winners'); box.innerHTML = '';
      list.forEach((w,i)=>{
        const el = document.createElement('div');
        el.className = 'win';
        el.innerHTML = `<div class="badge">${i+1}</div>
                        <div><div class="u">@${w.username}</div>
                        <div class="c">${w.count} participation${w.count>1?'s':''}</div></div>`;
        box.appendChild(el);
      });
      if(list.length) confettiBoom();
    }

    // ---- confetti ----
    const cvs = document.getElementById('confetti'); const ctx = cvs.getContext('2d');
    function resize(){ cvs.width = innerWidth; cvs.height = innerHeight; } addEventListener('resize',resize); resize();
    let confetti=[]; 
    function confettiBoom(){
      const colors = ['#5b5bff','#6be3ff','#22c55e','#f59e0b','#ef4444','#a78bfa','#e879f9','#34d399'];
      for(let i=0;i<160;i++){
        confetti.push({x:Math.random()*cvs.width, y:-10, r:4+Math.random()*6, vx:-2+Math.random()*4, vy:2+Math.random()*3, c:colors[Math.floor(Math.random()*colors.length)], rot:Math.random()*360, vr:-6+Math.random()*12});
      }
      setTimeout(()=>confetti=[], 2500);
    }
    (function loop(){
      requestAnimationFrame(loop);
      ctx.clearRect(0,0,cvs.width,cvs.height);
      confetti.forEach(p=>{ p.x+=p.vx; p.y+=p.vy; p.vy+=0.03; p.rot+=p.vr;
        ctx.save(); ctx.translate(p.x,p.y); ctx.rotate(p.rot*Math.PI/180); ctx.fillStyle=p.c; ctx.fillRect(-p.r,-p.r,p.r*2,p.r*2); ctx.restore();
      });
      confetti = confetti.filter(p=>p.y < cvs.height+20);
    })();

    // ---- load participants ----
    let participants = [];
    async function load(){
      try{
        const res = await fetch(participantsUrl, {cache:'no-store'});
        if(!res.ok) throw new Error('HTTP '+res.status);
        const text = await res.text();
        participants = parseCSV(text);
        if(!participants.length) throw new Error('CSV vide/mal form√©');
        status(`Participants charg√©s : ${participants.length}`, true);
        $('#roulette').removeAttribute('disabled');
      }catch(e){
        status('Erreur chargement participants : '+e, false);
        $('#roulette').setAttribute('disabled','true');
      }
    }

    // ---- roulette actions ----
    const btn = $('#roulette');
    let spinning = false;
    btn.addEventListener('click', async ()=>{
      if(spinning || !participants.length) return;
      spinning = true;
      btn.classList.add('spin');
      status('Tirage en cours‚Ä¶');
      await new Promise(r=>setTimeout(r, 1800)); // petite attente "effet"
      const winners = drawWeightedUnique(participants, N_WINNERS);
      btn.classList.remove('spin'); spinning = false;
      renderWinners(winners);
      status('Tirage effectu√© (mode pond√©r√©).', true);
    });

    load();
  </script>
</body>
</html>
