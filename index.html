<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tirage au sort ‚Äî Concours Tensosport</title>
  <meta name="description" content="Tirage au sort du concours Tensosport ‚Äî s√©lection transparente des gagnants" />
  <style>
    :root{
      --bg1:#0f1020; --bg2:#171a35; --accent:#5b5bff; --accent-2:#6be3ff; --text:#e9ecf1; --muted:#aab2c8; --card:#101325cc;
      --ok:#20c997; --warn:#ffcd39;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; color:var(--text); font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Apple Color Emoji","Segoe UI Emoji";
      background: radial-gradient(1200px 1200px at 10% -10%, #19204e 0%, transparent 60%),
                  radial-gradient(1200px 1200px at 110% 10%, #082b3a 0%, transparent 60%),
                  linear-gradient(135deg, var(--bg1), var(--bg2));
    }
    .wrap{max-width:1000px;margin:0 auto;padding:28px}
    header{
      display:flex;align-items:center;justify-content:space-between;gap:16px;margin-bottom:18px
    }
    .brand{
      display:flex;align-items:center;gap:12px
    }
    .logo{
      width:42px;height:42px;border-radius:12px;
      background: conic-gradient(from 0deg, var(--accent), var(--accent-2), var(--accent));
      box-shadow: 0 0 0 3px #ffffff10, 0 8px 30px #0006;
    }
    h1{font-size:clamp(22px, 3.6vw, 34px);margin:0}
    .sub{color:var(--muted);font-size:14px}
    .card{
      background:linear-gradient(180deg, #ffffff10, #00000010);
      backdrop-filter: blur(10px);
      border:1px solid #ffffff1a; border-radius:18px; box-shadow:0 20px 60px #0007;
    }
    .panel{padding:18px}
    .row{display:flex;flex-wrap:wrap;gap:12px}
    .row > *{flex:1;min-width:180px}
    label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
    input[type="number"], select, input[type="text"]{
      width:100%;padding:12px 12px;border:1px solid #ffffff26;border-radius:12px;background:#0f1220d9;color:var(--text);
      outline:none; transition:.2s;
    }
    input[type="number"]:focus, select:focus, input[type="text"]:focus{border-color:var(--accent)}
    .btn{
      appearance:none;border:none;border-radius:14px;padding:12px 16px;font-weight:700;color:white;cursor:pointer;transition:.2s;
      background: linear-gradient(135deg, var(--accent), var(--accent-2));
      box-shadow: 0 8px 28px #0008, inset 0 0 0 1px #ffffff33;
    }
    .btn:hover{transform: translateY(-1px); filter:saturate(1.1)}
    .btn:disabled{opacity:.5;cursor:not-allowed;transform:none}
    .btn-secondary{
      background: #ffffff14;color:#fff;font-weight:600
    }
    .hint{font-size:12px;color:var(--muted);margin-top:8px}
    .winners{padding:16px 18px 22px}
    .grid{
      display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:14px
    }
    .winner{
      border:1px solid #ffffff26;border-radius:16px;padding:14px 14px;background:#0d1126cc;display:flex;align-items:center;gap:12px
    }
    .badge{
      width:36px;height:36px;border-radius:50%;display:grid;place-items:center;font-weight:800;
      background:linear-gradient(135deg,#22c55e,#10b981);color:white;box-shadow:0 6px 18px #0006
    }
    .uname{font-weight:700}
    .count{color:var(--muted);font-size:12px}
    footer{margin:26px 0 10px;color:#95a1be;font-size:12px;text-align:center}
    .drop{
      border:1px dashed #ffffff33;border-radius:14px;padding:14px;text-align:center;color:#cfe7ff;background:#0b0f22a0
    }
    .drop.drag{background:#0e1636;border-color:#6be3ff}
    /* Confetti canvas */
    #confetti{position:fixed;inset:0;pointer-events:none}
  </style>
</head>
<body>
  <canvas id="confetti"></canvas>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1>Tirage au sort ‚Äî Concours <span style="color:var(--accent-2)">Tensosport</span></h1>
          <div class="sub">Charge le fichier <b>participants_counts.csv</b> puis tire les gagnants en toute transparence.</div>
        </div>
      </div>
      <button id="btnCopy" class="btn-secondary" title="Copier la liste">Copier la liste</button>
    </header>

    <section class="card panel" aria-labelledby="ctrls">
      <h2 id="ctrls" style="margin:0 0 10px;font-size:16px;color:#cfe7ff">Param√®tres du tirage</h2>
      <div class="row">
        <div>
          <label>Mode de tirage</label>
          <select id="mode">
            <option value="one">√âgalitaire ‚Äî 1 chance par personne</option>
            <option value="weighted">Pond√©r√© ‚Äî 1 ticket par commentaire</option>
          </select>
        </div>
        <div>
          <label>Nombre de gagnants</label>
          <input id="count" type="number" min="1" max="50" value="5" />
        </div>
        <div>
          <label>Seed (optionnel, pour refaire le m√™me tirage)</label>
          <input id="seed" type="text" placeholder="ex: tensosport2025" />
        </div>
      </div>

      <div class="row" style="margin-top:12px">
        <div>
          <label>Charger le CSV depuis le repo (auto)</label>
          <button id="btnFetch" class="btn">Charger participants_counts.csv</button>
          <div class="hint">Le fichier doit √™tre √† la racine du m√™me dossier que cette page.</div>
        </div>
        <div>
          <label>‚Ä¶ou d√©poser / choisir un fichier CSV</label>
          <div id="drop" class="drop">Glisse-d√©pose ton <b>participants_counts.csv</b> ici, ou <u>clique pour s√©lectionner</u>.</div>
          <input id="file" type="file" accept=".csv,text/csv" hidden />
          <div class="hint">Format attendu : <code>username,comment_count</code> (en-t√™te inclus).</div>
        </div>
      </div>

      <div style="margin-top:16px;display:flex;gap:10px;flex-wrap:wrap">
        <button id="btnDraw" class="btn" disabled>Tirer au sort</button>
        <div id="status" class="hint"></div>
      </div>
    </section>

    <section class="card winners" aria-live="polite" aria-atomic="true">
      <h2 style="margin:0 0 8px;font-size:16px;color:#cfe7ff">Gagnants üéâ</h2>
      <div id="winners" class="grid"></div>
    </section>

    <footer>Made with ‚ù§Ô∏è pour @tensosport_fr ‚Äî tirage local, al√©atoire et transparent.</footer>
  </div>

  <script>
    // ---------- Utils ----------
    const $ = s => document.querySelector(s);
    const status = (msg, ok=false) => { $('#status').textContent = msg; $('#status').style.color = ok ? 'var(--ok)' : 'var(--muted)'; };

    // Simple CSV parser for "username,comment_count"
    function parseCSV(text){
      const lines = text.trim().split(/\r?\n/);
      if(!lines.length) return [];
      const out = [];
      let start = 0;
      // detect header
      if(/username/i.test(lines[0]) && /count/i.test(lines[0])) start = 1;
      for(let i=start;i<lines.length;i++){
        const line = lines[i].trim();
        if(!line) continue;
        // naive split, but fine for two columns with no commas inside
        const [u,c] = line.split(',');
        const username = (u||'').replace(/^"+|"+$/g,'').trim();
        const count = parseInt((c||'1').replace(/[^0-9]/g,'')) || 1;
        if(username) out.push({username, count});
      }
      return out;
    }

    // Seeded RNG (Mulberry32)
    function mulberry32(a){ return function(){ var t = a += 0x6D2B79F5; t = Math.imul(t ^ t >>> 15, t | 1); t ^= t + Math.imul(t ^ t >>> 7, t | 61); return ((t ^ t >>> 14) >>> 0) / 4294967296; } }
    function hashStr(s){ let h=2166136261>>>0; for(let i=0;i<s.length;i++){ h^=s.charCodeAt(i); h=Math.imul(h,16777619);} return h>>>0; }

    function drawWinners(participants, howMany=5, mode='one', seedStr=''){
      if(!participants.length) return [];
      let rng = Math.random;
      if(seedStr){ rng = mulberry32(hashStr(seedStr)); }
      // Build ticket pool
      let pool = [];
      if(mode === 'weighted'){
        participants.forEach(p => { for(let i=0;i<p.count;i++) pool.push(p.username); });
      } else {
        pool = [...new Set(participants.map(p => p.username))];
      }
      // Draw unique winners
      const winners = [];
      const taken = new Set();
      while(winners.length < Math.min(howMany, new Set(pool).size) && pool.length){
        const idx = Math.floor(rng()*pool.length);
        const pick = pool[idx];
        if(!taken.has(pick)){
          taken.add(pick);
          winners.push(pick);
          // remove all tickets of the winner
          pool = pool.filter(x => x !== pick);
        }
      }
      return winners.map(u => {
        const found = participants.find(p => p.username === u);
        return { username: u, count: found ? found.count : 1 };
      });
    }

    function renderWinners(list){
      const box = $('#winners');
      box.innerHTML = '';
      list.forEach((w,i)=>{
        const el = document.createElement('div');
        el.className = 'winner';
        el.innerHTML = `
          <div class="badge">${i+1}</div>
          <div>
            <div class="uname">@${w.username}</div>
            <div class="count">${w.count} participation${w.count>1?'s':''}</div>
          </div>`;
        box.appendChild(el);
      });
      if(list.length) confettiBoom();
    }

    // ---------- Confetti ----------
    // lightweight confetti
    const confettiCanvas = document.getElementById('confetti');
    const ctx = confettiCanvas.getContext('2d');
    let confetti = [];
    function resize(){ confettiCanvas.width = window.innerWidth; confettiCanvas.height = window.innerHeight; }
    window.addEventListener('resize', resize); resize();

    function confettiBoom(){
      const colors = ['#5b5bff','#6be3ff','#22c55e','#f59e0b','#ef4444','#a78bfa','#e879f9','#34d399'];
      for(let i=0;i<160;i++){
        confetti.push({
          x: Math.random()*confettiCanvas.width,
          y: -10,
          r: 4+Math.random()*6,
          vx: -2+Math.random()*4,
          vy: 2+Math.random()*3,
          color: colors[Math.floor(Math.random()*colors.length)],
          rot: Math.random()*360,
          vr: -6+Math.random()*12
        });
      }
      // auto stop after a moment
      setTimeout(()=>confetti=[], 2500);
    }
    (function loop(){
      requestAnimationFrame(loop);
      ctx.clearRect(0,0,confettiCanvas.width, confettiCanvas.height);
      confetti.forEach(p=>{
        p.x += p.vx; p.y += p.vy; p.vy += 0.03; p.rot += p.vr;
        ctx.save();
        ctx.translate(p.x, p.y);
        ctx.rotate(p.rot*Math.PI/180);
        ctx.fillStyle = p.color;
        ctx.fillRect(-p.r, -p.r, p.r*2, p.r*2);
        ctx.restore();
      });
      confetti = confetti.filter(p=>p.y < confettiCanvas.height+20);
    })();

    // ---------- Data loading ----------
    let participants = []; // {username, count}
    function enableDraw(enable){ $('#btnDraw').disabled = !enable; }

    async function fetchCSV(){
      status('Chargement du CSV depuis le repo‚Ä¶');
      try{
        const res = await fetch('participants_counts.csv', {cache:'no-store'});
        if(!res.ok) throw new Error('HTTP '+res.status);
        const text = await res.text();
        participants = parseCSV(text);
        if(!participants.length) throw new Error('CSV vide ou mal form√©');
        status(`CSV charg√© ‚Äî ${participants.length} lignes.`, true);
        enableDraw(true);
      }catch(e){
        status(`√âchec du chargement auto : ${e}. Utilise l‚Äôupload ci-contre.`, false);
        enableDraw(false);
      }
    }

    function readFile(file){
      const reader = new FileReader();
      reader.onload = () => {
        const text = reader.result;
        participants = parseCSV(text);
        if(!participants.length){
          status('Fichier invalide (aucune ligne lisible).', false);
          enableDraw(false);
          return;
        }
        status(`Fichier charg√© ‚Äî ${participants.length} lignes.`, true);
        enableDraw(true);
      };
      reader.readAsText(file);
    }

    // ---------- Events ----------
    $('#btnFetch').addEventListener('click', fetchCSV);
    $('#btnDraw').addEventListener('click', ()=>{
      if(!participants.length){ status('Charge d‚Äôabord le CSV.', false); return; }
      const mode = $('#mode').value === 'weighted' ? 'weighted' : 'one';
      const n = Math.max(1, Math.min(50, parseInt($('#count').value || '5', 10)));
      const seed = ($('#seed').value || '').trim();
      const list = drawWinners(participants, n, mode, seed);
      renderWinners(list);
      status(`Tirage effectu√© (${mode === 'weighted' ? 'pond√©r√©' : '√©galitaire'}) ‚Äî ${list.length} gagnant(s).`, true);
      // save winners to clipboard text
      window._lastWinners = list.map(w=>`@${w.username} (${w.count})`).join('\n');
    });

    // Copy winners
    $('#btnCopy').addEventListener('click', async ()=>{
      const txt = window._lastWinners || '';
      if(!txt){ status('Aucun tirage encore effectu√©.', false); return; }
      try{ await navigator.clipboard.writeText(txt); status('Liste copi√©e dans le presse-papiers ‚úÖ', true); }
      catch{ status('Impossible de copier (permissions navigateur).', false); }
    });

    // Dropzone
    const drop = $('#drop'); const fileInput = $('#file');
    drop.addEventListener('click', ()=>fileInput.click());
    fileInput.addEventListener('change', e => { if(e.target.files?.[0]) readFile(e.target.files[0]); });
    ['dragenter','dragover'].forEach(ev=>drop.addEventListener(ev, e=>{ e.preventDefault(); drop.classList.add('drag'); }));
    ['dragleave','drop'].forEach(ev=>drop.addEventListener(ev, e=>{ e.preventDefault(); drop.classList.remove('drag'); }));
    drop.addEventListener('drop', e=>{
      const f = e.dataTransfer?.files?.[0]; if(f) readFile(f);
    });

    // Auto-try fetch on load (if CSV is already in repo)
    fetchCSV();
  </script>
</body>
</html>
